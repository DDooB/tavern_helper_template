<head>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* [Design] ì´ˆì••ì¶•í˜• ë ˆì´ì•„ì›ƒ */
        .compact-status {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border: 1px solid #c9a45c;
            border-radius: 4px;
            color: #e0e0e0;
            padding: 8px 12px;
            font-family: 'Cinzel', serif;
            max-width: 500px;
            margin: 5px auto;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
        }

        /* í”Œë ˆì´ì–´ ìš”ì•½ ë¼ì¸ (í•œ ì¤„ ë°°ì¹˜) */
        .summary-line {
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            font-size: 0.95em;
        }

        .player-info {
            display: flex;
            gap: 10px;
            align-items: center;
            font-weight: bold;
        }

        .gold-val { color: #ffd700; } /* ê³¨ë“œ ì „ìš© í™©ê¸ˆìƒ‰ */

        /* í¼ì³ì§€ëŠ” ìƒì„¸ ì˜ì—­ */
        .party-dropdown {
            display: none;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid rgba(201, 164, 92, 0.3);
        }
        .party-dropdown.active { display: block; }

        .m-detail-row {
            background: rgba(0, 0, 0, 0.2);
            padding: 6px 10px;
            margin-bottom: 4px;
            border-radius: 3px;
            font-size: 0.85em;
        }

        .m-top-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
        }

        /* í•˜íŠ¸(Love Level) ì»¨í…Œì´ë„ˆ */
        .love-hearts { color: #ff4d4d; font-size: 0.9em; letter-spacing: -1px; }

        /* ì»´íŒ©íŠ¸ ê²Œì´ì§€ë°” */
        .mini-gauge {
            height: 3px;
            background: #333;
            border-radius: 1px;
            overflow: hidden;
        }
        .mini-fill { height: 100%; background: #ff4d4d; transition: width 0.4s ease; }
    </style>

    <script type="module">
        const posMap = { 'ë§ŒëŠ¥': 'ğŸ’', 'íƒ±ì»¤': 'ğŸ›¡ï¸', 'ë”œëŸ¬': 'âš”ï¸', 'íëŸ¬': 'âœ¨' };

        async function refreshUI() {
            const currentVars = getVariables({type: 'message'});
            const stats = _.get(currentVars, 'stat_data', {});

            // 1. í”Œë ˆì´ì–´ ìš”ì•½ (í•œ ì¤„)
            const p = _.get(stats, 'í”Œë ˆì´ì–´', {});
            $('#sum-lv').text(`Lv.${p.ë ˆë²¨ || 1}`);
            $('#sum-pos').text(posMap[p.í¬ì§€ì…˜] || 'ğŸ’');
            $('#sum-job').text(p.ì§ì—… || 'ëª¨í—˜ê°€');
            $('#sum-gold').text(`${(p.ì†Œì§€_ê³¨ë“œ || 0).toLocaleString()} G`);

            // 2. íŒŒí‹°ì› ìƒì„¸
            for (let i = 1; i <= 3; i++) {
                const m = _.get(stats, `íŒŒí‹°ì›${i}`);
                const $row = $(`#m-row-${i}`);

                if (m && m.ì´ë¦„ !== 'ì´ë¦„ ì—†ìŒ') {
                    $row.find('.m-name').text(`${m.ì´ë¦„} (Lv.${m.ë ˆë²¨})`);
                    $row.find('.m-job-pos').text(`${posMap[m.í¬ì§€ì…˜] || 'ğŸ’'} ${m.ì§ì—…}`);
                    
                    // Love Level í•˜íŠ¸ ê°œìˆ˜ í‘œì‹œ
                    const heartCount = Math.max(0, m.love_level || 0);
                    $row.find('.love-hearts').text('â™¥ï¸'.repeat(heartCount));
                    
                    // ê²Œì´ì§€
                    $row.find('.mini-fill').css('width', `${m.í˜¸ê°ë„ || 0}%`);
                    $row.show();
                } else {
                    $row.hide();
                }
            }
        }

        async function init() {
            await waitGlobalInitialized('Mvu');
            
            // ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ ê°ì‹œ
            eventOn(Mvu.events.VARIABLE_UPDATE_ENDED, refreshUI);
            refreshUI();

            // í¼ì¹˜ê¸° í† ê¸€
            $('#summary-trigger').on('click', function() {
                const $drop = $('.party-dropdown');
                $drop.toggleClass('active');
                $(this).find('.arrow').text($drop.hasClass('active') ? 'â–²' : 'â–¼');
            });
        }

        $(document).ready(() => {
            if (typeof errorCatched !== 'undefined') errorCatched(init)();
            else init();
        });
    </script>
</head>

<div class="compact-status">
    <div class="summary-line" id="summary-trigger">
        <div class="player-info">
            <span id="sum-lv">Lv.1</span>
            <span id="sum-pos">ğŸ’</span>
            <span id="sum-job">ëª¨í—˜ê°€</span>
            <span id="sum-gold" class="gold-val">0 G</span>
        </div>
        <span class="arrow" style="color:#c9a45c;">â–¼</span>
    </div>

    <div class="party-dropdown">
        <div id="m-row-1" class="m-detail-row">
            <div class="m-top-info">
                <span><span class="m-name" style="color:#fff; font-weight:bold;">-</span> <span class="m-job-pos" style="margin-left:5px; color:#aaa;">-</span></span>
                <span class="love-hearts"></span>
            </div>
            <div class="mini-gauge"><div class="mini-fill"></div></div>
        </div>
        <div id="m-row-2" class="m-detail-row">
            <div class="m-top-info">
                <span><span class="m-name" style="color:#fff; font-weight:bold;">-</span> <span class="m-job-pos" style="margin-left:5px; color:#aaa;">-</span></span>
                <span class="love-hearts"></span>
            </div>
            <div class="mini-gauge"><div class="mini-fill"></div></div>
        </div>
        <div id="m-row-3" class="m-detail-row">
            <div class="m-top-info">
                <span><span class="m-name" style="color:#fff; font-weight:bold;">-</span> <span class="m-job-pos" style="margin-left:5px; color:#aaa;">-</span></span>
                <span class="love-hearts"></span>
            </div>
            <div class="mini-gauge"><div class="mini-fill"></div></div>
        </div>
    </div>
</div>