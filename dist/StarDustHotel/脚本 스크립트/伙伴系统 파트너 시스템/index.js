const e=z,t=['EX','S','A','B','C','D'];function r(e){const r=e.trim().toUpperCase();return t.includes(r)?r:'D'}function n(e){const t=e.trim().toLowerCase();return'tank'===t?'tank':'dps'===t?'dps':'heal'===t||'healer'===t?'heal':'support'===t?'support':'allround'===t||'all_round'===t||'all-round'===t||'allrounder'===t||'all-rounder'===t?'allRound':'support'}const a=e.z.object({User:e.z.object({Level:e.z.coerce.number().transform(e=>Math.max(1,Math.trunc(e))),Costume:e.z.string(),SDP:e.z.coerce.number().transform(e=>Math.max(0,Math.trunc(e))),Inventory:e.z.record(e.z.string().describe('Item ID'),e.z.object({Description:e.z.string(),Quantity:e.z.coerce.number().transform(e=>Math.max(0,Math.trunc(e)))})),PartySlots:e.z.record(e.z.enum(['Slot1','Slot2','Slot3']),e.z.string()),PartySlotData:e.z.record(e.z.enum(['Slot1','Slot2','Slot3']),e.z.union([e.z.literal(''),e.z.object({PartnerId:e.z.string(),Name:e.z.string(),Level:e.z.coerce.number().transform(e=>Math.max(1,Math.trunc(e))),Grade:e.z.string().transform(e=>r(e)),Class:e.z.string().transform(e=>n(e)),Job:e.z.string(),Affinity:e.z.coerce.number().transform(e=>Math.trunc(e)),LoveLevel:e.z.coerce.number().transform(e=>_.clamp(Math.trunc(e),-5,5)),Fatigue:e.z.coerce.number().transform(e=>_.clamp(Math.trunc(e),0,100)),Alive:e.z.boolean()})])),_OwnedPartnerCount:e.z.coerce.number().transform(e=>Math.max(0,Math.trunc(e)))}),Mission:e.z.object({OnMission:e.z.boolean(),MissionType:e.z.enum(['normal','eros']),MissionGrade:e.z.enum(['S','A','B','C','D']),WorldName:e.z.string(),WorldSummaryAndObjective:e.z.string()})}).transform(e=>{const t=['Slot1','Slot2','Slot3'],a=[];for(const r of t){const t=e.User.PartySlots[r].trim();''===t||a.includes(t)||a.push(t)}return t.forEach((t,o)=>{const s=a[o]??'';e.User.PartySlots[t]=s;const i=e.User.PartySlotData[t];if(''===s||''===i)return void(e.User.PartySlotData[t]='');let l=Math.trunc(i.Affinity),u=_.clamp(Math.trunc(i.LoveLevel),-5,5);for(;l>=100&&u<5;)l-=100,u+=1;for(;l<=-100&&u>-5;)l+=100,u-=1;e.User.PartySlotData[t]={...i,PartnerId:s,Level:Math.max(1,Math.trunc(i.Level)),Grade:r(i.Grade),Class:n(i.Class),Affinity:_.clamp(l,-99,99),LoveLevel:_.clamp(u,-5,5),Fatigue:_.clamp(Math.trunc(i.Fatigue),0,100)}}),e.User._OwnedPartnerCount=Math.max(0,Math.trunc(e.User._OwnedPartnerCount)),e.Mission.OnMission?(''===e.Mission.WorldName.trim()&&(e.Mission.WorldName='스타더스트 호텔'),''===e.Mission.WorldSummaryAndObjective.trim()&&(e.Mission.WorldSummaryAndObjective='임무 진행중')):(e.Mission.MissionType='normal',e.Mission.MissionGrade='D',e.Mission.WorldName='스타더스트 호텔',e.Mission.WorldSummaryAndObjective='대기중'),e}),o=(Vue,['Slot1','Slot2','Slot3']),s=5e4,i=[{grade:'EX',weight:.1},{grade:'S',weight:1},{grade:'A',weight:5},{grade:'B',weight:15},{grade:'C',weight:30},{grade:'D',weight:48.9}],l=[{grade:'EX',weight:2},{grade:'S',weight:8},{grade:'A',weight:20},{grade:'B',weight:30},{grade:'C',weight:40},{grade:'D',weight:0}],u=['EX','S','A','B','C','D'];function c(e){const t=e.trim().toUpperCase();return u.includes(t)?t:null}function m(e,t='D'){return c(e)??t}function f(e){const t=e.trim().toLowerCase();return'tank'===t?'tank':'dps'===t?'dps':'heal'===t||'healer'===t?'heal':'support'===t?'support':'allround'===t||'all_round'===t||'all-round'===t||'allrounder'===t||'all-rounder'===t?'allRound':null}function d(e,t='support'){return f(e)??t}function p(e){return e.trim().toLowerCase().replace(/\s+/g,'_').replace(/[^a-z0-9_]/g,'')}function v(e){return e.trim().toLowerCase()}function g(e){return`{{SDH_BRIEF_${e.toUpperCase()}}}`}function y(e){return`{{SDH_DETAIL_${e.toUpperCase()}}}`}function b(){return Date.now()}function D(e,t){const r=Number(e);return Number.isFinite(r)?Math.trunc(r):t}function h(e){const t={...e};for(t.Level=Math.max(1,D(t.Level,1)),t.Fatigue=_.clamp(D(t.Fatigue,0),0,100),t.LoveLevel=_.clamp(D(t.LoveLevel,0),-5,5),t.Affinity=D(t.Affinity,0);t.Affinity>=100&&t.LoveLevel<5;)t.Affinity-=100,t.LoveLevel+=1;for(;t.Affinity<=-100&&t.LoveLevel>-5;)t.Affinity+=100,t.LoveLevel-=1;return t.Affinity=_.clamp(t.Affinity,-99,99),t.Alive||(t.InParty=!1),t}function S(e){const t=p(e.Id);return{Id:t,Meta:{Name:e.Name.trim(),Grade:m(e.Grade),Class:d(e.Class),Job:e.Job.trim()||'미정'},State:h({Level:e.Level??1,Affinity:e.Affinity??0,LoveLevel:e.LoveLevel??0,Fatigue:0,Alive:!0,InParty:!1}),ProfileKeys:{BriefKey:(e.BriefKey??g(t)).trim(),DetailKey:(e.DetailKey??y(t)).trim()},UpdatedAt:b()}}function M(e){const t=p(e.id||e.name);return{Id:t,Name:e.name.trim()||t,Grade:m(e.grade??'D'),Class:d(e.clazz??'support'),Job:(e.job??'미정').trim()||'미정',BriefKey:(e.briefKey??g(t)).trim(),DetailKey:(e.detailKey??y(t)).trim()}}function w(){const e=S({Id:'luna',Name:'Luna',Grade:'B',Class:'support',Job:'정보 중개인',Level:1,Affinity:15,LoveLevel:0});e.State.InParty=!0,e.State.Fatigue=20;const t=S({Id:'rhea',Name:'Rhea',Grade:'C',Class:'heal',Job:'전투 의무관',Level:1,Affinity:-5,LoveLevel:0});t.State.Fatigue=10;return{partnerDb:{luna:e,rhea:t},runtime:{briefQueue:[],csvUrl:'',pool:{luna:M({id:'luna',name:'Luna',grade:'B',clazz:'support',job:'정보 중개인'}),rhea:M({id:'rhea',name:'Rhea',grade:'C',clazz:'heal',job:'전투 의무관'})},lastPoolSyncAt:0}}}function A(e){updateVariablesWith(t=>(_.set(t,'sdh',e),t),{type:'chat'})}function P(){const e=function(){const e=getVariables({type:'chat'}),t=_.cloneDeep(_.get(e,'sdh'));if(!t||!_.isPlainObject(t))return w();const r=w();return{partnerDb:_.isPlainObject(t.partnerDb)?t.partnerDb:r.partnerDb,runtime:{briefQueue:Array.isArray(t.runtime?.briefQueue)?t.runtime.briefQueue.map(String):[],csvUrl:'string'==typeof t.runtime?.csvUrl?t.runtime.csvUrl:'',pool:_.isPlainObject(t.runtime?.pool)?t.runtime.pool:r.runtime.pool,lastPoolSyncAt:Number(t.runtime?.lastPoolSyncAt??0)}}}();if(function(e){for(const t of Object.values(e.partnerDb))t.Meta.Grade=m(t.Meta.Grade,'D'),t.Meta.Class=d(t.Meta.Class,'support');for(const t of Object.keys(e.runtime.pool)){const r=e.runtime.pool[t];e.runtime.pool[t]={...r,Grade:m(r.Grade,'D'),Class:d(r.Class,'support')}}}(e),0===Object.keys(e.partnerDb).length){const e=w();return A(e),e}return 0===Object.keys(e.runtime.pool).length&&(e.runtime.pool=w().runtime.pool,A(e)),e}function L(e){return Object.values(e.partnerDb).filter(e=>e.State.InParty&&e.State.Alive).map(e=>e.Id).slice(0,o.length)}function C(e,t){const r=new Set(t);for(const t of Object.values(e.partnerDb))t.State.InParty=t.State.Alive&&r.has(t.Id),t.State=h(t.State),t.UpdatedAt=b()}function I(e){return a.parse(e)}function N(e){return{PartnerId:e.Id,Name:e.Meta.Name,Level:e.State.Level,Grade:e.Meta.Grade,Class:e.Meta.Class,Job:e.Meta.Job,Affinity:e.State.Affinity,LoveLevel:e.State.LoveLevel,Fatigue:e.State.Fatigue,Alive:e.State.Alive}}function U(e,t){const r=L(e);for(let n=0;n<o.length;n+=1){const a=o[n],s=r[n]??'';t.User.PartySlots[a]=s,s&&e.partnerDb[s]?t.User.PartySlotData[a]=N(e.partnerDb[s]):t.User.PartySlotData[a]=''}t.User._OwnedPartnerCount=Object.keys(e.partnerDb).length}async function k(e){await waitGlobalInitialized('Mvu');const t=Mvu.getMvuData({type:'message',message_id:'latest'}),r=I(t.stat_data);U(e,r),t.stat_data=r,await Mvu.replaceMvuData(t,{type:'message',message_id:'latest'})}function O(e){if(0===e.length)return;const t=P(),r=new Set(t.runtime.briefQueue);for(const n of e){const e=p(n),a=t.partnerDb[e];a&&(!a.State.InParty&&a.State.Alive&&r.add(e))}t.runtime.briefQueue=Array.from(r),A(t)}async function j(e){const t=Math.trunc(e);await waitGlobalInitialized('Mvu');const r=Mvu.getMvuData({type:'message',message_id:'latest'}),n=I(r.stat_data);return n.User.SDP=Math.max(0,Math.trunc(n.User.SDP+t)),r.stat_data=n,await Mvu.replaceMvuData(r,{type:'message',message_id:'latest'}),n.User.SDP}async function G(e){return!(await async function(){await waitGlobalInitialized('Mvu');const e=I(Mvu.getMvuData({type:'message',message_id:'latest'}).stat_data);return Math.max(0,Math.trunc(e.User.SDP))}()<e)&&(await j(-e),!0)}function B(e){const t=[];let r='',n=!1;for(let a=0;a<e.length;a+=1){const o=e[a];'"'!==o?','!==o||n?r+=o:(t.push(r),r=''):n&&'"'===e[a+1]?(r+='"',a+=1):n=!n}return t.push(r),t.map(e=>e.trim())}function E(e,t){const r=e.map(e=>e.trim().toLowerCase());for(const e of t){const t=r.indexOf(e.toLowerCase());if(t>=0)return t}return-1}async function K(e){const t=P();if(function(e,t){if(e.partnerDb[t.Id])return!0;const r=v(t.Name);return Object.values(e.partnerDb).some(e=>v(e.Meta.Name)===r)}(t,e)){const t=Math.trunc(500);return{ok:!0,code:'ok',message:`${e.Name} 중복 소환: SDP 50% 환급`,spent:0,refund:t,partnerId:e.Id,partnerName:e.Name,isDuplicate:!0}}const r=S({Id:e.Id,Name:e.Name,Grade:e.Grade,Class:e.Class,Job:e.Job,BriefKey:e.BriefKey,DetailKey:e.DetailKey});return t.partnerDb[r.Id]=r,t.runtime.briefQueue=_.uniq([...t.runtime.briefQueue,r.Id]),A(t),await k(t),{ok:!0,code:'ok',message:`${r.Meta.Name} 소환 성공`,spent:0,refund:0,partnerId:r.Id,partnerName:r.Meta.Name,isDuplicate:!1}}async function x(e,t){const r=p(e),n=P(),a=n.partnerDb[r];if(!a)return toastr.error(`등록되지 않은 파트너 ID: ${r}`),!1;if(!a.State.Alive)return toastr.error(`${a.Meta.Name}은(는) 생존 상태가 아니어서 편성할 수 없습니다.`),!1;const s=L(n),i={Slot1:'',Slot2:'',Slot3:''};for(let e=0;e<o.length;e+=1){const t=o[e];i[t]=s[e]??''}if(t){for(const e of o)i[e]===r&&(i[e]='');i[t]=r}else if(!Object.values(i).includes(r)){const e=o.find(e=>''===i[e]);if(!e)return toastr.warning('파티 슬롯이 가득 찼습니다. 슬롯 지정 편성을 사용하세요.'),!1;i[e]=r}return C(n,o.map(e=>i[e]).filter(e=>''!==e)),A(n),await k(n),!0}async function F(e){const t=P(),r=e.trim();let n='';if(o.includes(r)){const e=r,a=L(t);n=a[o.indexOf(e)]??''}else n=p(r);return!!(n&&t.partnerDb[n]&&t.partnerDb[n].State.InParty)&&(t.partnerDb[n].State.InParty=!1,t.partnerDb[n].UpdatedAt=b(),C(t,L(t).filter(e=>e!==n)),A(t),await k(t),!0)}async function J(e,t,r){if(t.spent=e,!r)return t;const n=Math.trunc(e/2);return await j(n),t.refund=n,t.message=`${t.partnerName??''} 중복 소환: SDP ${n} 환급`,t}async function Q(e){const t='normal'===e?1e3:5e3;if(!await G(t))return{ok:!1,code:'insufficient_sdp',message:'SDP가 부족합니다.',spent:0,refund:0};const r=P(),n=Object.values(r.runtime.pool);if(0===n.length)return await j(t),{ok:!1,code:'empty_pool',message:'가챠 풀이 비어 있습니다.',spent:0,refund:0};const a=function(e){const t=e.reduce((e,t)=>e+Math.max(0,t.weight),0);if(t<=0)return'D';let r=Math.random()*t;for(const t of e)if(r-=Math.max(0,t.weight),r<=0)return t.grade;return e[e.length-1]?.grade??'D'}('normal'===e?i:l).toUpperCase(),o=n.filter(e=>e.Grade.trim().toUpperCase()===a),s=o.length>0?o:n,u=(c=s)[Math.floor(Math.random()*c.length)];var c;const m=await K(u);return m.partnerId=u.Id,m.partnerName=u.Name,m.isDuplicate=Boolean(m.isDuplicate),J(t,m,Boolean(m.isDuplicate))}async function R(e){const t=e.trim();if(''===t)return{ok:!1,code:'pickup_not_found',message:'이름을 입력하세요.',spent:0,refund:0};if(!await G(s))return{ok:!1,code:'insufficient_sdp',message:'SDP가 부족합니다.',spent:0,refund:0};const r=function(e,t){const r=v(t);return Object.values(e).find(e=>v(e.Name)===r)??null}(P().runtime.pool,t);if(!r)return await j(s),{ok:!1,code:'pickup_not_found',message:'가챠 풀에 없는 이름입니다. 다시 입력하세요.',spent:0,refund:0};const n=await K(r);return n.partnerId=r.Id,n.partnerName=r.Name,n.isDuplicate=Boolean(n.isDuplicate),J(s,n,Boolean(n.isDuplicate))}async function W(e){const t=p(e.Id||e.Name);if(!t||!e.Name.trim())return{ok:!1,code:'custom_id_exists',message:'이름/ID를 확인하세요.',spent:0,refund:0};const r=c(e.Grade);if(!r)return{ok:!1,code:'invalid_grade',message:'Invalid Grade. Use one of: EX, S, A, B, C, D.',spent:0,refund:0};const n=f(e.Class);if(!n)return{ok:!1,code:'invalid_class',message:'Invalid Class. Use one of: tank, dps, heal, support, allRound.',spent:0,refund:0};const a=P(),o=v(e.Name);if(Object.values(a.runtime.pool).some(e=>v(e.Name)===o))return toastr.warning('이미 소환풀 목록에 있는 파트너입니다.'),{ok:!1,code:'custom_name_exists_in_pool',message:'이미 소환풀 목록에 있는 파트너입니다.',spent:0,refund:0};if(a.partnerDb[t])return{ok:!1,code:'custom_id_exists',message:'이미 존재하는 파트너 ID입니다.',spent:0,refund:0};if(!await G(1e4))return{ok:!1,code:'insufficient_sdp',message:'SDP가 부족합니다.',spent:0,refund:0};const s=S({Id:t,Name:e.Name,Grade:r,Class:n,Job:e.Job,Level:e.Level,Affinity:e.Affinity,LoveLevel:e.LoveLevel,BriefKey:e.BriefKey,DetailKey:e.DetailKey});return a.partnerDb[s.Id]=s,a.runtime.briefQueue=_.uniq([...a.runtime.briefQueue,s.Id]),A(a),await k(a),{ok:!0,code:'ok',message:`${s.Meta.Name} 커스텀 등록 완료`,spent:1e4,refund:0,partnerId:s.Id,partnerName:s.Meta.Name,isDuplicate:!1}}async function T(e){const t=P();t.runtime.csvUrl=e.trim(),A(t)}async function V(){const e=P(),t=e.runtime.csvUrl.trim();if(''===t)return{ok:!1,message:'CSV URL이 비어 있습니다.',count:0};try{const r=await fetch(t);if(!r.ok)return{ok:!1,message:`CSV 다운로드 실패 (${r.status})`,count:0};const n=function(e){const t=e.split(/\r?\n/).map(e=>e.trim()).filter(e=>''!==e);if(t.length<2)return{};const r=B(t[0]),n=E(r,['id','partner_id','파트너id','파트너 id']),a=E(r,['name','partner_name','이름','파트너명','partner']),o=E(r,['grade','등급']),s=E(r,['class','clazz','클래스']),i=E(r,['job','직업']),l=E(r,['brief_key','brief','간단키','간단프로필키']),u=E(r,['detail_key','detail','상세키','상세프로필키']),c={};for(let e=1;e<t.length;e+=1){const r=B(t[e]),m=a>=0?r[a]??'':'';if(''===m.trim())continue;const f=M({id:n>=0?r[n]??m:m,name:m,grade:o>=0?r[o]:'D',clazz:s>=0?r[s]:'support',job:i>=0?r[i]:'미정',briefKey:l>=0?r[l]:void 0,detailKey:u>=0?r[u]:void 0});c[f.Id]=f}return c}(await r.text());return 0===Object.keys(n).length?{ok:!1,message:'CSV 파싱 결과가 비어 있습니다.',count:0}:(e.runtime.pool=n,e.runtime.lastPoolSyncAt=b(),A(e),{ok:!0,message:`가챠 풀 ${Object.keys(n).length}명 로드 완료`,count:Object.keys(n).length})}catch(e){return{ok:!1,message:`CSV 로드 오류: ${e instanceof Error?e.message:String(e)}`,count:0}}}async function q(){const e=P();await waitGlobalInitialized('Mvu');const t=I(Mvu.getMvuData({type:'message',message_id:'latest'}).stat_data),r=Math.max(0,Math.trunc(t.User.SDP)),n={Slot1:'',Slot2:'',Slot3:''};for(let e=0;e<o.length;e+=1){const r=o[e];n[r]=t.User.PartySlots[r]??''}const a=Object.values(e.partnerDb).map(e=>({Id:e.Id,Name:e.Meta.Name,Grade:e.Meta.Grade,Class:e.Meta.Class,Job:e.Meta.Job,InParty:e.State.InParty,Alive:e.State.Alive,Level:e.State.Level})).sort((e,t)=>e.Name.localeCompare(t.Name));return{sdp:r,ownedCount:a.length,inPartyCount:a.filter(e=>e.InParty).length,poolCount:Object.keys(e.runtime.pool).length,csvUrl:e.runtime.csvUrl,lastPoolSyncAt:e.runtime.lastPoolSyncAt,partySlots:n,stat:{User:t.User,Mission:t.Mission},pool:Object.values(e.runtime.pool).sort((e,t)=>e.Name.localeCompare(t.Name)),ownedPartners:a}}function H(){eventOn(Mvu.events.VARIABLE_UPDATE_ENDED,e=>{const t=P(),r=I(e.stat_data);!function(e,t){const r=o.map(e=>t.User.PartySlots[e]).filter(Boolean),n=_(r).uniq().filter(t=>Boolean(e.partnerDb[t]&&e.partnerDb[t].State.Alive)).take(o.length).value();C(e,n);for(const r of o){const n=t.User.PartySlots[r];if(!n||!e.partnerDb[n])continue;const a=t.User.PartySlotData[r];''!==a&&(e.partnerDb[n].State=h({Level:a.Level,Affinity:a.Affinity,LoveLevel:a.LoveLevel,Fatigue:a.Fatigue,Alive:a.Alive,InParty:!0}),e.partnerDb[n].Meta.Name=a.Name.trim()||e.partnerDb[n].Meta.Name,e.partnerDb[n].Meta.Grade=m(a.Grade,e.partnerDb[n].Meta.Grade),e.partnerDb[n].Meta.Class=d(a.Class,e.partnerDb[n].Meta.Class),e.partnerDb[n].Meta.Job=a.Job.trim()||e.partnerDb[n].Meta.Job,e.partnerDb[n].UpdatedAt=b())}}(t,r),U(t,r),e.stat_data=r,A(t)}),eventOn(tavern_events.USER_MESSAGE_RENDERED,e=>{const t=getChatMessages(e,{include_swipes:!1})[0];if(!t||'user'!==t.role)return;const r=P(),n=function(e,t){const r=e.toLowerCase(),n=[];for(const e of Object.values(t.partnerDb))!e.State.InParty&&e.State.Alive&&[e.Id,e.Meta.Name].map(e=>e.toLowerCase()).filter(e=>e.length>0).some(e=>r.includes(e))&&n.push(e.Id);return _.uniq(n)}(t.message,r);n.length>0&&O(n)}),eventOn(tavern_events.GENERATION_AFTER_COMMANDS,(e,t,r)=>{if(r)return;const n=P(),a=function(e){const t=[...e.runtime.briefQueue];return e.runtime.briefQueue=[],t}(n),o=function(e,t){const r=L(e).map(t=>e.partnerDb[t]?.ProfileKeys.DetailKey).filter(e=>'string'==typeof e&&''!==e.trim()),n=t.map(t=>e.partnerDb[t]).filter(e=>Boolean(e)).filter(e=>!e.State.InParty&&e.State.Alive).map(e=>e.ProfileKeys.BriefKey).filter(e=>''!==e.trim());return _.uniq([...r,...n])}(n,a);o.length>0&&function(e){0!==e.length&&injectPrompts(e.map((e,t)=>({id:`sdh_profile_${b()}_${t}`,position:'none',depth:0,role:'system',content:e,should_scan:!0})),{once:!0})}(o),A(n)}),eventOn(tavern_events.CHAT_CHANGED,()=>{k(P())})}$(async()=>{await waitGlobalInitialized('Mvu');const e=P();await k(e),H(),function(){const e={getSnapshot:q,setPoolCsvUrl:T,refreshPoolFromCsv:V,drawGacha:Q,pickupByName:R,registerCustomPartner:W,addPartnerToParty:x,removePartnerFromParty:F,grantSdp:j,queueBriefProfile:e=>O([e]),syncNow:async()=>{const e=P();await k(e)}};window.SDH=e;try{window.top.SDH=e}catch{}}()});
//# sourceMappingURL=index.js.map